<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout :: layout(~{::title}, ~{::main})}">
<head>
    <title>智能预测 - 大乐透分析预测系统</title>
</head>
<body>
<main>
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="text-dark mb-3"><i class="bi bi-lightning-charge me-2"></i>智能预测</h2>
            </div>
        </div>

        <!-- 预测表单 -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-gear me-2"></i>预测设置</h5>
                    </div>
                    <div class="card-body">
                        <form id="predictForm">
                            <div class="mb-3">
                                <label class="form-label">目标期号</label>
                                <input type="text" class="form-control" name="targetIssue" 
                                       th:value="${nextIssue}" id="targetIssue">
                                <small class="text-muted">下一期预测期号</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">候选注数</label>
                                <select class="form-select" name="count" id="count">
                                    <option value="3">3 注</option>
                                    <option value="5" selected>5 注</option>
                                    <option value="10">10 注</option>
                                    <option value="20">20 注</option>
                                </select>
                                <small class="text-muted">每种方法生成的候选数量，生成后自动为每种方法推荐一注</small>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-lightning-charge me-2"></i>生成预测
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>预测方法说明</h5>
                    </div>
                    <div class="card-body">
                        <dl>
                            <dt><span class="badge bg-danger">热号优先</span> HOT</dt>
                            <dd class="text-muted mb-3">基于近30期出现频率最高的号码生成预测，追踪热门趋势</dd>
                            
                            <dt><span class="badge bg-warning text-dark">遗漏回补</span> MISSING</dt>
                            <dd class="text-muted mb-3">选择遗漏值接近平均遗漏的号码，捕捉即将"回归"的号码</dd>
                            
                            <dt><span class="badge bg-success">冷热均衡</span> BALANCED</dt>
                            <dd class="text-muted mb-3">热号3个 + 温号1个 + 冷号1个，兼顾趋势与概率平衡</dd>
                            
                            <dt><span class="badge bg-info">机器学习</span> ML</dt>
                            <dd class="text-muted mb-3">综合频率、遗漏、趋势、相邻关联等多维特征的模式识别</dd>
                            
                            <dt><span class="badge bg-primary">自适应预测</span> ADAPTIVE</dt>
                            <dd class="text-muted mb-3">根据各方法历史命中率动态调整权重，持续学习优化</dd>
                        </dl>
                        <hr>
                        <h6 class="text-primary"><i class="bi bi-star me-1"></i>推荐说明</h6>
                        <p class="text-muted small mb-0">
                            点击「生成预测」后，系统会为每种方法生成多注候选并全部展示；
                            同时基于历史命中模式相似度，为每种方法自动推荐一注最可能命中的号码。
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 预测结果 -->
        <div class="row">
            <div class="col-12">
                <div class="card" id="resultCard" style="display:none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>预测结果</h5>
                        <span class="badge bg-success" id="resultCount"></span>
                    </div>
                    <div class="card-body">
                        <div id="recommendationsSection" class="mb-4"></div>
                        <h6 class="mb-2"><i class="bi bi-table me-1"></i>全部生成数据</h6>
                        <div id="resultContainer"></div>
                    </div>
                </div>
                
                <!-- Loading -->
                <div class="card" id="loadingCard" style="display:none;">
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 mb-0">正在生成预测...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('predictForm').addEventListener('submit', function(e) {
            e.preventDefault();

            var targetIssue = document.getElementById('targetIssue').value;
            var count = document.getElementById('count').value;

            document.getElementById('loadingCard').style.display = 'block';
            document.getElementById('resultCard').style.display = 'none';

            var body = 'count=' + encodeURIComponent(count) + '&targetIssue=' + encodeURIComponent(targetIssue);

            fetch('/prediction/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: body
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingCard').style.display = 'none';

                if (data.success) {
                    var allPredictions = data.allPredictions || [];
                    var recommendations = data.recommendations || [];

                    document.getElementById('resultCard').style.display = 'block';
                    document.getElementById('resultCount').textContent = '共 ' + allPredictions.length + ' 注，' + recommendations.length + ' 条推荐';

                    var recIds = {};
                    recommendations.forEach(function(r) { recIds[r.id] = true; });

                    var recHtml = '<h6 class="mb-2"><i class="bi bi-star-fill me-1 text-warning"></i>每种方法推荐一注</h6>';
                    recHtml += '<div class="table-responsive"><table class="table table-hover table-sm">';
                    recHtml += '<thead><tr><th>预测方法</th><th>前区号码</th><th>后区号码</th></tr></thead><tbody>';
                    recommendations.forEach(function(p) {
                        recHtml += '<tr class="table-warning">';
                        recHtml += '<td><span class="badge bg-primary">' + p.methodName + '</span></td>';
                        recHtml += '<td>';
                        p.frontBalls.forEach(function(ball) {
                            recHtml += '<span class="ball ball-front" style="width:32px;height:32px;font-size:0.85rem;">' + String(ball).padStart(2, '0') + '</span>';
                        });
                        recHtml += '</td><td>';
                        p.backBalls.forEach(function(ball) {
                            recHtml += '<span class="ball ball-back" style="width:32px;height:32px;font-size:0.85rem;">' + String(ball).padStart(2, '0') + '</span>';
                        });
                        recHtml += '</td></tr>';
                    });
                    recHtml += '</tbody></table></div>';
                    document.getElementById('recommendationsSection').innerHTML = recHtml;

                    var html = '<div class="table-responsive"><table class="table table-hover">';
                    html += '<thead><tr><th>#</th><th>预测方法</th><th>前区号码</th><th>后区号码</th><th>说明</th></tr></thead><tbody>';

                    allPredictions.forEach(function(p, idx) {
                        var isRec = recIds[p.id];
                        html += '<tr' + (isRec ? ' class="table-warning"' : '') + '>';
                        html += '<td>' + (idx + 1) + '</td>';
                        html += '<td><span class="badge bg-secondary">' + p.methodName + '</span></td>';
                        html += '<td>';
                        p.frontBalls.forEach(function(ball) {
                            html += '<span class="ball ball-front" style="width:32px;height:32px;font-size:0.85rem;">' + String(ball).padStart(2, '0') + '</span>';
                        });
                        html += '</td><td>';
                        p.backBalls.forEach(function(ball) {
                            html += '<span class="ball ball-back" style="width:32px;height:32px;font-size:0.85rem;">' + String(ball).padStart(2, '0') + '</span>';
                        });
                        html += '</td>';
                        html += '<td>' + (isRec ? '<span class="badge bg-success"><i class="bi bi-star-fill me-1"></i>推荐</span>' : '') + '</td>';
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                    html += '<div class="alert alert-info mt-3 mb-0"><i class="bi bi-info-circle me-2"></i>' + (data.message || '') + '</div>';
                    document.getElementById('resultContainer').innerHTML = html;
                } else {
                    alert(data.message);
                }
            })
            .catch(function(error) {
                document.getElementById('loadingCard').style.display = 'none';
                alert('请求失败: ' + error);
            });
        });
    </script>
</main>
</body>
</html>
