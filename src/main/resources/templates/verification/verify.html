<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout :: layout(~{::title}, ~{::main})}">
<head>
    <title>验证预测 - 大乐透分析预测系统</title>
</head>
<body>
<main>
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="text-dark mb-3"><i class="bi bi-check-circle me-2"></i>验证预测结果</h2>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-search me-2"></i>选择验证期号</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3" th:if="${!#lists.isEmpty(unverifiedIssues)}">
                            <label class="form-label">待验证期号</label>
                            <select class="form-select" id="issueSelect">
                                <option value="">-- 选择期号 --</option>
                                <option th:each="issue : ${unverifiedIssues}" th:value="${issue}" th:text="${issue}"></option>
                            </select>
                        </div>
                        <div th:if="${#lists.isEmpty(unverifiedIssues)}" class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>暂无待验证的预测记录
                        </div>
                        
                        <div id="issueInfo" style="display:none;" class="mt-3">
                            <div class="alert alert-success" id="hasResultAlert" style="display:none;">
                                <i class="bi bi-check-circle me-2"></i>该期已有开奖结果，可以进行验证
                                <div class="mt-2" id="drawResultDisplay"></div>
                            </div>
                            <div class="alert alert-warning" id="noResultAlert" style="display:none;">
                                <i class="bi bi-exclamation-triangle me-2"></i>该期暂无开奖结果，无法验证
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary btn-lg w-100 mt-3" id="verifyBtn" disabled>
                            <i class="bi bi-check-all me-2"></i>执行验证
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>最新开奖结果</h5>
                    </div>
                    <div class="card-body text-center" th:if="${latestResult != null}">
                        <h6 class="text-muted">第 <span th:text="${latestResult.issue}"></span> 期</h6>
                        <div class="my-3">
                            <span class="ball ball-front" th:text="${latestResult.frontBall1}"></span>
                            <span class="ball ball-front" th:text="${latestResult.frontBall2}"></span>
                            <span class="ball ball-front" th:text="${latestResult.frontBall3}"></span>
                            <span class="ball ball-front" th:text="${latestResult.frontBall4}"></span>
                            <span class="ball ball-front" th:text="${latestResult.frontBall5}"></span>
                            <span class="mx-2">+</span>
                            <span class="ball ball-back" th:text="${latestResult.backBall1}"></span>
                            <span class="ball ball-back" th:text="${latestResult.backBall2}"></span>
                        </div>
                        <small class="text-muted" th:text="'开奖日期: ' + ${latestResult.drawDate}"></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 验证结果 -->
        <div class="row">
            <div class="col-12">
                <div class="card" id="resultCard" style="display:none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>验证结果</h5>
                        <div>
                            <span class="badge bg-info me-2" id="totalCount"></span>
                            <span class="badge bg-success" id="prizeCount"></span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>预测方法</th>
                                        <th>预测号码</th>
                                        <th>前区命中</th>
                                        <th>后区命中</th>
                                        <th>中奖等级</th>
                                    </tr>
                                </thead>
                                <tbody id="resultTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var issueSelect = document.getElementById('issueSelect');
        var verifyBtn = document.getElementById('verifyBtn');
        var issueInfo = document.getElementById('issueInfo');
        var hasResultAlert = document.getElementById('hasResultAlert');
        var noResultAlert = document.getElementById('noResultAlert');
        var drawResultDisplay = document.getElementById('drawResultDisplay');
        
        if (issueSelect) {
            issueSelect.addEventListener('change', function() {
                var issue = this.value;
                if (!issue) {
                    issueInfo.style.display = 'none';
                    verifyBtn.disabled = true;
                    return;
                }
                
                fetch('/verification/api/checkIssue?issue=' + issue)
                    .then(response => response.json())
                    .then(data => {
                        issueInfo.style.display = 'block';
                        if (data.hasResult && data.drawResult) {
                            hasResultAlert.style.display = 'block';
                            noResultAlert.style.display = 'none';
                            verifyBtn.disabled = false;
                            
                            var dr = data.drawResult;
                            drawResultDisplay.innerHTML = 
                                '<span class="ball ball-front" style="width:28px;height:28px;font-size:0.75rem;">' + dr.frontBall1 + '</span>' +
                                '<span class="ball ball-front" style="width:28px;height:28px;font-size:0.75rem;">' + dr.frontBall2 + '</span>' +
                                '<span class="ball ball-front" style="width:28px;height:28px;font-size:0.75rem;">' + dr.frontBall3 + '</span>' +
                                '<span class="ball ball-front" style="width:28px;height:28px;font-size:0.75rem;">' + dr.frontBall4 + '</span>' +
                                '<span class="ball ball-front" style="width:28px;height:28px;font-size:0.75rem;">' + dr.frontBall5 + '</span>' +
                                ' + ' +
                                '<span class="ball ball-back" style="width:28px;height:28px;font-size:0.75rem;">' + dr.backBall1 + '</span>' +
                                '<span class="ball ball-back" style="width:28px;height:28px;font-size:0.75rem;">' + dr.backBall2 + '</span>';
                        } else {
                            hasResultAlert.style.display = 'none';
                            noResultAlert.style.display = 'block';
                            verifyBtn.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('检查期号失败:', error);
                        issueInfo.style.display = 'block';
                        hasResultAlert.style.display = 'none';
                        noResultAlert.style.display = 'block';
                        verifyBtn.disabled = true;
                    });
            });
        }
        
        verifyBtn.addEventListener('click', function() {
            var issue = issueSelect.value;
            if (!issue) return;
            
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>验证中...';
            
            fetch('/verification/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'issue=' + issue
            })
            .then(response => response.json())
            .then(data => {
                verifyBtn.innerHTML = '<i class="bi bi-check-all me-2"></i>执行验证';
                
                if (data.success) {
                    document.getElementById('resultCard').style.display = 'block';
                    document.getElementById('totalCount').textContent = '共验证 ' + data.data.length + ' 条';
                    document.getElementById('prizeCount').textContent = '中奖 ' + data.prizeCount + ' 条';
                    
                    var html = '';
                    data.data.forEach(function(p) {
                        var prizeClass = '';
                        if (p.prizeLevel === '一等奖') prizeClass = 'prize-1';
                        else if (p.prizeLevel === '二等奖') prizeClass = 'prize-2';
                        else if (p.prizeLevel === '三等奖') prizeClass = 'prize-3';
                        else if (p.prizeLevel === '未中奖') prizeClass = 'prize-none';
                        else prizeClass = 'prize-other';
                        
                        html += '<tr>';
                        html += '<td><span class="badge bg-secondary">' + p.methodName + '</span></td>';
                        html += '<td>';
                        p.frontBalls.forEach(function(ball) {
                            html += '<span class="ball ball-front" style="width:28px;height:28px;font-size:0.75rem;">' + ball + '</span>';
                        });
                        html += ' + ';
                        p.backBalls.forEach(function(ball) {
                            html += '<span class="ball ball-back" style="width:28px;height:28px;font-size:0.75rem;">' + ball + '</span>';
                        });
                        html += '</td>';
                        html += '<td class="text-danger fw-bold">' + p.frontHitCount + '</td>';
                        html += '<td class="text-primary fw-bold">' + p.backHitCount + '</td>';
                        html += '<td><span class="prize-badge ' + prizeClass + '">' + p.prizeLevel + '</span></td>';
                        html += '</tr>';
                    });
                    
                    document.getElementById('resultTableBody').innerHTML = html;
                    
                    // 从列表中移除已验证的期号
                    var option = issueSelect.querySelector('option[value="' + issue + '"]');
                    if (option) option.remove();
                    issueSelect.value = '';
                    issueInfo.style.display = 'none';
                } else {
                    alert(data.message);
                    verifyBtn.disabled = false;
                }
            })
            .catch(error => {
                verifyBtn.innerHTML = '<i class="bi bi-check-all me-2"></i>执行验证';
                verifyBtn.disabled = false;
                alert('请求失败: ' + error);
            });
        });
    </script>
</main>
</body>
</html>
