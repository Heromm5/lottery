<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::title}, ~{::section})}">
<head>
    <title>关联分析 - 大乐透分析预测系统</title>
</head>
<body>
<section>
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-diagram-3 me-2"></i>号码关联分析 - <span th:text="${zoneName}">前区</span></span>
                    <div>
                        <a th:href="@{/analysis/association(zone='front')}" 
                           th:class="${zone == 'front'} ? 'btn btn-light btn-sm' : 'btn btn-outline-light btn-sm'">前区</a>
                        <a th:href="@{/analysis/association(zone='back')}" 
                           th:class="${zone == 'back'} ? 'btn btn-light btn-sm' : 'btn btn-outline-light btn-sm'">后区</a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 关联网络图 -->
                    <div id="associationChart" style="width: 100%; height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-table me-2"></i>关联规则详情（按提升度排序）
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>前件（如果出现）</th>
                                    <th>后件（则易出现）</th>
                                    <th>支持度</th>
                                    <th>置信度</th>
                                    <th>提升度</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="rule, iter : ${rules}" th:if="${iter.index < 30}">
                                    <td th:text="${iter.index + 1}">1</td>
                                    <td>
                                        <span th:each="num : ${rule.antecedent}" 
                                              th:class="${zone == 'front'} ? 'ball ball-front' : 'ball ball-back'"
                                              th:text="${#numbers.formatInteger(num, 2)}">01</span>
                                    </td>
                                    <td>
                                        <span th:each="num : ${rule.consequent}" 
                                              th:class="${zone == 'front'} ? 'ball ball-front' : 'ball ball-back'"
                                              th:text="${#numbers.formatInteger(num, 2)}">02</span>
                                    </td>
                                    <td th:text="${#numbers.formatDecimal(rule.support * 100, 1, 2) + '%'}">5.00%</td>
                                    <td th:text="${#numbers.formatDecimal(rule.confidence * 100, 1, 2) + '%'}">30.00%</td>
                                    <td>
                                        <span th:class="${rule.lift > 1.5} ? 'badge bg-success' : 'badge bg-info'"
                                              th:text="${#numbers.formatDecimal(rule.lift, 1, 2)}">1.50</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info mt-3" th:if="${#lists.isEmpty(rules)}">
                        <i class="bi bi-info-circle me-2"></i>暂无符合条件的关联规则
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-lightbulb me-2"></i>说明
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li><strong>支持度</strong>：两个号码同时出现的频率（占总期数的比例）</li>
                        <li><strong>置信度</strong>：当前件号码出现时，后件号码也出现的概率</li>
                        <li><strong>提升度</strong>：大于1表示正相关，值越大关联越强；等于1表示无关；小于1表示负相关</li>
                        <li>仅显示提升度大于1的正相关规则</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        var zone = /*[[${zone}]]*/ 'front';
        
        // 加载关联网络数据
        fetch('/analysis/api/association?zone=' + zone + '&topN=50')
            .then(response => response.json())
            .then(data => {
                var chart = echarts.init(document.getElementById('associationChart'));
                
                var nodes = data.nodes.map(function(n) {
                    return {
                        name: n.name,
                        value: n.frequency,
                        symbolSize: Math.max(25, Math.min(50, n.frequency / 2)),
                        itemStyle: {
                            color: zone === 'front' ? '#e63946' : '#457b9d'
                        }
                    };
                });
                
                var links = data.links.map(function(l) {
                    return {
                        source: l.source,
                        target: l.target,
                        value: l.lift,
                        lineStyle: {
                            width: Math.max(1, (l.lift - 1) * 3),
                            color: 'rgba(150, 150, 150, 0.6)'
                        }
                    };
                });
                
                var option = {
                    title: {
                        text: '号码关联网络图',
                        subtext: '节点大小表示出现频率，连线粗细表示关联强度',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            if (params.dataType === 'edge') {
                                return params.data.source + ' → ' + params.data.target + 
                                       '<br/>提升度: ' + params.data.value.toFixed(2);
                            }
                            return '号码 ' + params.name + '<br/>出现次数: ' + params.value;
                        }
                    },
                    series: [{
                        type: 'graph',
                        layout: 'force',
                        data: nodes,
                        links: links,
                        roam: true,
                        draggable: true,
                        label: {
                            show: true,
                            position: 'inside',
                            fontSize: 12,
                            fontWeight: 'bold',
                            color: '#fff'
                        },
                        force: {
                            repulsion: 200,
                            edgeLength: [80, 150],
                            gravity: 0.1
                        },
                        emphasis: {
                            focus: 'adjacency',
                            lineStyle: {
                                width: 5
                            }
                        }
                    }]
                };
                
                chart.setOption(option);
                
                window.addEventListener('resize', function() {
                    chart.resize();
                });
            });
    });
</script>
</body>
</html>
